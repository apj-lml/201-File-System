{% extends 'base.html' %}

{% block title %} Certificate of Employment {% endblock %}

{%block cssperfile %}
<link href="{{ url_for('static', filename='movingBg.css') }}" rel="stylesheet">

<style type="text/css">
	div.dtsb-searchBuilder div.dtsb-titleRow {
    	display: none;
}

label span { pointer-events: none; }
</style>

<!-- <link href="{{ url_for('static', filename='movingBg.css') }}" rel="stylesheet"> -->

<!-- Custom styles for this template -->

{% endblock %}

{% block content %}
<ul class="circles">
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
</ul>

<main class="container-fluid mt-3 mx-5">
	<div class="row mb-3 ms-auto">
    <!-- <ul class="circles">
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
      <li></li>
    </ul> -->
<!-- ----------------------------------------------------------------------- -->
<!--                                  FORMS                                  -->
<!-- ----------------------------------------------------------------------- -->

<div class="card mb-3 mt-4">
  <div class="card-body">
    <div class="card text-white bg-blue shadow-sm mb-3" >
      <div class="card-header">
        <h3 class="card-title text-white fw-bolder"><i class="bi bi-journals"></i> TRAVEL ORDER</h3>
       </div>
      <div class="card-body row">
        <div class="col-sm-6">
          <div class="row text-center">
            <!-- <div class="row col-sm-12 mb-3"> -->
              <div class="col-sm-12 col-md-6 mb-3 ">
                <div class="form-floating has-validation">
                  <input type="date" class="form-control" name ="date_created" id="date_created" placeholder="Date Created" disabled value="{{ today_date_formatted }}">
                  <label class="text-blue fw-bold" id="date_created" for="date_created">Date</label>
                </div>
              </div>
              <div class="form-floating col-sm-12 col-md-6 mb-3">
                <select class="form-select" id="is_outside_ilocos" name="is_outside_ilocos" value="">
                  <option value="false">OUTSIDE ILOCOS REGION</option>
                  <option value="true" selected>WITHIN ILOCOS REGION</option>
                </select>
                <label for="is_outside_ilocos" class="text-blue fw-bold">Coverage Area<span class="is-required">*</span></label>
              </div>
              
            
  
            <!-- </div> -->
            <div class="col-sm-12">
              <div class="row">
                <div class="col-sm-12 col-md-6 mb-3 ">
                  <div class="form-floating has-validation">
                    <input type="date" class="form-control" name ="date_from" id="date_from" placeholder="Date From" value="" required>
                    <label class="text-blue fw-bold" id="date_from" for="date_from">Date From</label>
                  </div>
                </div>
                <div class="col-sm-12 col-md-6 mb-3 ">
                  <div class="form-floating has-validation">
                    <input type="date" class="form-control" name ="date_to" id="date_to" placeholder="Date To" value="" required>
                    <label class="text-blue fw-bold" id="date_to" for="date_to">Date To</label>
                  </div>
                </div>
              </div>
            </div>
  
              <div class="col-sm-12 col-md-12 mb-3">
                <div class="form-floating has-validation">
                    <input type="text" class="form-control" name ="location" id="location" placeholder="Location" value="" required>
                    <label class="text-blue fw-bold" id="location" for="location">Location<span class="is-required">*</span></label>
                </div>
              </div>
  
            <div class="col-sm-12">
              <div class="form-floating">
                <textarea class="form-control" placeholder="Purpose" id="purpose" style="height: 150px" required></textarea>
                <label for="purpose" class="text-blue fw-bold">Purpose<span class="is-required">*</span></label>
              </div>
            </div>
            <div class="col-sm-12">
              <h1 class="text-white">MEMO FOR:</h1>
              <ol id="memoFor">
                <li class="text-start">{{ user_profile.proper_fullname }}</li>
              </ol>
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="card">
            <div class="card-body">
              <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for names..">
              <div class="container">
                <ul id="myUL">
                  <div class="row">
                    <div class="col-sm-6">
                      {% for user in users %}
                        {% if loop.index % 4 == 1 and not loop.first %}
                          </div> <!-- Close the previous column -->
                          <div class="col-sm-6"> <!-- Start a new column -->
                        {% endif %}
                        
                        <li class="myLI" for="checkbox_{{ user.id }}">
                          <input type="checkbox" class="user-checkbox" id="checkbox_{{ user.id }}" onclick="updateSelectedIds()">
                          <label class="form-check-label" for="checkbox_{{ user.id }} text-blue fw-bold">
                            <span href="#" id="span_{{ user.id }}" class="text-blue fw-bold d-inline">{{ user.proper_fullname }}</span>
                          </label>
                        </li>
          
                        {% if loop.last %}
                          </div> <!-- Close the last column -->
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                </ul>
                <a href="#" id="seeMoreBtn" onclick="seeMore()" style="display:none;">See more...</a>
                <a href="#" id="seeLessBtn" onclick="seeLess()" style="display:none;">See less...</a>
              </div>
            </div>
        </div>
      </div>
    </div>



      
  <div class="col-sm-12 text-center mt-3">
    <button href="#" class="btn btn-primary" onclick="printTO();" {{ '' if user_profile.employment_status == "JOB ORDER" }}><i class="bi bi-printer"></i> PRINT CERTIFICATION</button>
</div>


</div>

      </div>
      </div>
    </div>
    </main>

    <!-- Modal -->
<div class="modal fade" id="uploadRolModal" tabindex="-1" aria-labelledby="uploadRolModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadRolModalLabel">Upload Records of Leave</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="#" method="POST" name="rol_form" id="rol_form" enctype="multipart/form-data" onsubmit="loadingScreen('block')">
          <div class="mb-3">
            <label for="form_file" class="form-label">You can only upload 1 file at a time.</label>
            <input class="form-control" type="file" id="rolFile" name="rolFile" form="rol_form" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary" form="rol_form">Upload</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{%block scripts%}
<script src="{{ url_for('static', filename='sgjg.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4"></script>
<script src="https://unpkg.com/downloadjs@1.4.7"></script>


<script type="text/javascript">

  let allListItems = [];
  const initialVisibleItems = 48;
  let currentlyVisibleItems = initialVisibleItems;
  let selectedIds = [];

  function updateSelectedIds() {
    // Clear the current selected IDs
    selectedIds = [];
    selectedNames = ['{{ user_profile.proper_fullname }}'];
    
    // Get all checkboxes
    const checkboxes = document.querySelectorAll('.user-checkbox');
    // Loop through checkboxes and add checked ones to the array
    checkboxes.forEach((checkbox) => {

      if (checkbox.checked) {
        selectedIds.push(checkbox.id.replace('checkbox_', '')); // Extract user ID from checkbox ID
        selectedNames.push(document.getElementById('span_' + checkbox.id.replace('checkbox_', '')).innerHTML); // Extract name from checkbox ID
      }
    });


    let liHtml = '';
    selectedNames.forEach((name)=>{
      liHtml += `<li class="text-start">${name}</li>`;
    });

    // document.getElementById('memoFor').insertAdjacentHTML('beforeend', liHtml);
     document.getElementById('memoFor').innerHTML = liHtml;

  }
  
  function myFunction() {
    // Declare variables
    var input, filter, ul, li, a, i, txtValue, keywords;
    input = document.getElementById('myInput');
    filter = input.value.toUpperCase();
    ul = document.getElementById("myUL");
    li = ul.getElementsByClassName('myLI');
    
    // Store all items in an array if not already done
    if (allListItems.length === 0) {
      allListItems = Array.from(li);
    }
  
    // Clear the list and get all matching items
    let matchedItems = [];
    
    // Loop through all list items
    for (i = 0; i < allListItems.length; i++) {
      a = allListItems[i].getElementsByTagName("span")[0];
      txtValue = a.textContent || a.innerText;
  
      // Check if all keywords are present in the name (case-insensitive)
      let allKeywordsMatch = filter.split(" ").every(function(keyword) {
        return txtValue.toUpperCase().indexOf(keyword) > -1;
      });
  
      // If it matches, add it to matchedItems
      if (allKeywordsMatch) {
        matchedItems.push(allListItems[i]);
      }
    }
  
    // Hide all items initially
    for (i = 0; i < allListItems.length; i++) {
      allListItems[i].style.display = "none"; 
    }
  
    // Show the matched items
    for (i = 0; i < Math.min(matchedItems.length, currentlyVisibleItems); i++) {
      matchedItems[i].style.display = "";  // Make them visible
    }
  
    // Show "See more..." button if there are more items
    document.getElementById('seeMoreBtn').style.display = matchedItems.length > currentlyVisibleItems ? "block" : "none";
    // Show "See less..." button if more than initialVisibleItems are shown
    document.getElementById('seeLessBtn').style.display = currentlyVisibleItems > initialVisibleItems ? "block" : "none";
  
    // Rearrange matched items into columns
    rearrangeColumns();
  }
  
  function rearrangeColumns() {
    const columns = document.querySelectorAll('.col-sm-3');
    columns.forEach(col => {
      // Clear current content in each column
      col.innerHTML = '';
    });
  
    // Redistribute matched items into columns
    let colIndex = 0;
    for (let item of allListItems) {
      if (item.style.display !== "none") {
        columns[colIndex].appendChild(item);
        colIndex = (colIndex + 1) % columns.length; // Move to the next column
      }
    }
  }
  
  function seeMore() {
    currentlyVisibleItems += 100; // Increase the number of visible items
    myFunction(); // Reapply the filter and display logic
  }
  
  function seeLess() {
    currentlyVisibleItems = initialVisibleItems; // Reset to the initial number of visible items
    myFunction(); // Reapply the filter and display logic
  }
  
  // Initial display of the first 100 names on page load
  document.addEventListener('DOMContentLoaded', (event) => {
    myFunction(); // Call to ensure the first 100 items are shown initially
  });


  function printTO(){
    loadingScreen('block')
    var is_outside_ilocos = document.getElementById('is_outside_ilocos');
    var date_from = document.getElementById('date_from');
    var date_to = document.getElementById('date_to');
    var location = document.getElementById('location');
    var purpose = document.getElementById('purpose');
    
    fetch('/travelOrder/print-to/{{user_profile.id}}', {
      method: 'POST',
      body: JSON.stringify({
                            'selectedIds': selectedIds,
                            'is_outside_ilocos' : is_outside_ilocos.value,
                            'date_from' : date_from.value,
                            'date_to' : date_to.value,
                            'location' : location.value,
                            'purpose' : purpose.value,
                                })
    }).then((res) => res.blob())
      .then((blob) => URL.createObjectURL(blob))
      .then((href) => {
          Object.assign(document.createElement('a'), {
            href,
            download: 'travel_order_{{ user_profile.last_name }}.docx',
          }).click();
      setTimeout(loadingScreen('none'), 2000);
      
    })
  }




</script>
{%endblock%}