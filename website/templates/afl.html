{% extends 'base.html' %}

{% block title %} Application for Leave {% endblock %}

{%block cssperfile %} 
<style type="text/css">
	div.dtsb-searchBuilder div.dtsb-titleRow {
    	display: none;
}
</style>

<link href="{{ url_for('static', filename='movingBg.css') }}" rel="stylesheet">

{% endblock %}

{% block content %}
<main class="container-fluid mt-4 ps-5 pe-5 pb-5">
	<ul class="circles">
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
	  </ul>
	<div class="row mb-3 mt-4">
		<div class="card col-md-8">
			<div class="card-body">
				<form id="add_afl_form" action="#" method="POST" enctype="multipart/form-data"></form>
				<div class="card text-white bg-blue shadow-sm mb-3" >
					<div class="card-header">
						<h3 class="card-title"><i class="bi bi-calendar-week"></i> Application for Leave</h3>
					</div>
					<div class="card-body">
					  <ul>
						<li><p class="card-text">Please fill out all necessary fields.</p></li>
						<!-- <li><p class="card-text">Take note that updating your file attachment will overwirte the old attachment.</p></li> -->
					  </ul>
					</div>
				</div>
				<div class="card shadow-sm mb-3">
					<div class="card-body">
						<div class="d-md-flex flex-row">
                            <div class="form-floating flex-fill mb-3 p-1">
								<select class="form-select" id="leave_id" name="leave_id" form="add_afl_form">
									<option value="1">Vacation Leave</option>
									<option value="2">Mandatory/Forced Leave</option>
									<option value="3">Sick Leave</option>
									<option value="4">Maternity Leave</option>
									<option value="5">Paternity Leave</option>
									<option value="6">Special Privilege Leave</option>
									<option value="7">Solo Parent Leave</option>
									<option value="8">Study Leave </option>
									<option value="9">10-Day VAWC Leave</option>
									<option value="10">Special Leave Benefits for Women</option>
									<option value="11">Special Emergency (Calamity) Leave</option>
									<option value="12">Adoption Leave</option>
								</select>
								<label for="leave_id">Type of Leave</label>
							</div>
                            <div class="form-floating flex-fill mb-3 p-1">
								<input type="date" class="form-control" name ="ld_date_from" placeholder="Inclusive Date of Attendance From" form="add_afl_form" max="9999-12-31" required>
								<label for="ld_date_from[1]">Inclusive Date From</label>
							</div>
							<div class="form-floating flex-fill mb-3 p-1">
								<input type="date" class="form-control" name ="ld_date_to" placeholder="Inclusive Date of Attendance To" form="add_afl_form" max="5000-12-31" required>
								<label for="ld_date_to[1]">Inclusive Date To</label>
							</div>
						</div>
						<div class="d-md-flex flex-row">
							<div class="form-floating flex-fill mb-3 p-1">
								<input type="number" class="form-control" name ="no_working_days_applied_for" placeholder="Rating" form="add_afl_form" required step="any" min="1">
								<label for="no_working_days_applied_for">Number of Working Days Applied for</label>
							</div>
						</div>

						<div class="d-md-flex flex-row">
                            <h6>In case of Vacation/Special Privilage Leave:</h6>
                        </div>
						<div class="d-md-flex flex-row">
							<div class="mb-3 p-1 col-md-6">
								<div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="1" id="wph" name="wph">
                                    <label class="form-check-label" for="wph">
                                      Within the Philippines
                                    </label>
                                    <div class="form-floating flex-fill mb-3 p-1">
                                        <input type="text" class="form-control" name ="wph_remarks" placeholder="Remarks" form="add_afl_form">
                                        <label for="wph_remarks">Remarks</label>
                                    </div>
                                  </div>
							</div>
                            <div class="mb-3 p-1 col-md-6">
								<div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="1" id="abroad" name="abroad">
                                    <label class="form-check-label" for="abroad">
                                      Abroad
                                    </label>
                                    <div class="form-floating flex-fill mb-3 p-1">
                                        <input type="text" class="form-control" name ="abroad_remarks" placeholder="Remarks" form="add_afl_form">
                                        <label for="abroad_remarks">Remarks</label>
                                    </div>
                                  </div>
							</div>
						</div>
                        <div class="d-md-flex flex-row">
                            <h6>In case of Sick Leave:</h6>
                        </div>
						<div class="d-md-flex flex-row">
							<div class="mb-3 p-1 col-md-6">
								<div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="1" id="in_hospital" name="in_hospital">
                                    <label class="form-check-label" for="in_hospital">
                                        In Hospital
                                    </label>
                                    <div class="form-floating flex-fill mb-3 p-1">
                                        <input type="text" class="form-control" name ="in_hospital_illness" placeholder="(Specify Illness)" form="add_afl_form">
                                        <label for="in_hospital_illness">(Specify Illness)</label>
                                    </div>
                                  </div>
							</div>
                            <div class="mb-3 p-1 col-md-6">
								<div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="1" id="out_patient" name="out_patient">
                                    <label class="form-check-label" for="out_patient">
                                        Out Patient
                                    </label>
                                    <div class="form-floating flex-fill mb-3 p-1">
                                        <input type="text" class="form-control" name ="out_patient_illness" placeholder="(Specify Illness)" form="add_afl_form">
                                        <label for="out_patient_illness">(Specify Illness)</label>
                                    </div>
                                  </div>
							</div>
						</div>

                        <div class="d-md-flex flex-row">
                            <h6>In case of Special Leave Benefits for Women:</h6>
                        </div>

                        <div class="d-md-flex flex-row">
							<div class="mb-3 p-1 col-md-6">
								<div class="form-check">
                                    <!-- <label class="form-check-label" for="in_hospital">
                                         (Specify Illness)
                                    </label> -->
                                    <div class="form-floating flex-fill mb-3 p-1">
                                        <input type="text" class="form-control" name ="in_hospital_illness" placeholder="(Specify Illness)" form="add_afl_form">
                                        <label for="in_hospital_illness">(Specify Illness)</label>
                                    </div>
                                  </div>
							</div>
						</div>

                        <div class="d-md-flex flex-row">
                            <h6>Commutation</h6>
                        </div>
						<div class="d-md-flex flex-row">
							<div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="inlineCheckbox1" value="option1">
                                <label class="form-check-label" for="inlineCheckbox1">Not Requested</label>
                              </div>
                              <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="inlineCheckbox2" value="option2">
                                <label class="form-check-label" for="inlineCheckbox2">Requested</label>
                              </div>
						</div>

						<div class="col-sm-12 text-center">
							<button type="submit" class="btn btn-primary" form="add_afl_form">Print AFL</button>
						</div>
					</div>
				</div>
				
				  <!-- <div class="card shadow-sm mb-3">
					<div class="card-body">
						<div class="col-sm-12">
								<div class="table-responsive">
									<table class="table table-striped text-left" id="ld_table" width = "100%">
										<colgroup>
											<col style="width: 5%" />
											<col style="width: 30%" />
											<col style="width: 14.28%" />
											<col style="width: 14.28%" />
											<col style="width: 10%" />
											<col style="width: 14.28%" />
											<col style="width: 20%" />
											<col style="width: 14.28%" />
											<col style="width: 14.28%" />
										</colgroup>
										<thead class="">
										<tr>
											<th scope="col">ID</th>
											<th scope="col">Title of L&D Interventions / Training Programs</th>
											<th scope="col">Inclusive Date (From)</th>
											<th scope="col">Inclusive Date (To)</th>
											<th scope="col">No. of Training Hours</th>
											<th scope="col">Type of L&D</th>
											<th scope="col">Conducted By</th>
											<th scope="col">Attachment</th>
											<th scope="col">Controls</th>
										</tr>
										</thead>
										<tbody>
										<tr>
										</tr>
										</tbody>
									</table>
								</div>
						</div>
					</div>
				</div> -->

			</div>
		</div>
	</div>
</main>

<!-- ----------------------------------------------------------------------- -->
<!--                                 Modals                                  -->
<!-- ----------------------------------------------------------------------- -->
<div class="modal fade" id="viewExpModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="viewExpModal" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-fullscreen-sm-down">
	  <div class="modal-content">
		<div class="modal-header text-white bg-blue">
		  <h5 class="modal-title" id="viewExpModal"><i class="bi bi-lightbulb"></i>Edit Learning & Development</h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-body">
		  <div class="row mb-3 container">
			<div class="card mb-3">
				<div class="card-body">
					<form action="#" method="POST" name="update_ld_form" id="update_ld_form" enctype="multipart/form-data"></form>
                <input type="hidden" class="form-control" name ="id" id="update_id" placeholder="" value="" form="update_ld_form">
					<div class="d-md-flex flex-row">
						<div class="form-floating flex-fill mb-3 p-1">
						  <textarea class="form-control" id ="update_ld_program" name ="ld_program" placeholder="Interventions/Training Program" form="update_ld_form" required></textarea>
						  <label for="ld_program[1]">Title of L&D Interventions / Training Programs</label>
						</div>
					</div>
					<div class="d-md-flex flex-row">
						<div class="form-floating flex-fill mb-3 p-1">
						  <input type="date" class="form-control"  id ="update_ld_date_from" name ="ld_date_from" placeholder="Inclusive Date of Attendance From" form="update_ld_form" required>
						  <label for="ld_date_from[1]">Inclusive Date of Attendance From</label>
						</div>
						<div class="form-floating flex-fill mb-3 p-1">
						  <input type="date" class="form-control" id ="update_ld_date_to" name ="ld_date_to" placeholder="Inclusive Date of Attendance To" form="update_ld_form" required>
						  <label for="ld_date_to[1]">Inclusive Date of Attendance To</label>
						</div>
					  </div>
					  <div class="d-md-flex flex-row">
						<div class="form-floating col-sm-4 mb-3 p-1">
						  <input type="number" class="form-control" id ="update_ld_no_hours" name ="ld_no_hours" placeholder="Rating" form="update_ld_form" required>
						  <label for="ld_no_hours[1]">Number of Hours</label>
						</div>
						  <div class="form-floating flex-fill mb-3 p-1">
							<select class="form-select" id="update_ld_type" name="leave_id" form="update_ld_form">
								<option value="TECHNICAL">TECHNICAL</option>
								<option value="MANAGERIAL">MANAGERIAL</option>
								<option value="SUPERVISORY">SUPERVISORY</option>
								<option value="FOUNDATION">FOUNDATION</option>
							</select>
							<label for="update_ld_no_hours" style="font-size: 12px;">Type of Learning & Development</label>
							<small class="text-muted" style="font-size: 12px;">*Eg. Managerial, Supervisory, Technical, etc.</small>

						  </div>
					  </div>
					  <div class="d-md-flex flex-row">
						<div class="form-floating flex-fill mb-3 p-1 col-md-6">
						  <input type="text" class="form-control" id ="update_ld_sponsored_by" name ="ld_sponsored_by" placeholder="Conducted By" form="update_ld_form" required>
						  <label for="ld_sponsored_by[1]">Conducted By</label>
						  <div class="form-check">
							<input class="form-check-input" type="checkbox" id="update_nia_pimo" name="nia_pimo" value = "NATIONAL IRRIGATION ADMINISTRATION - PANGASINAN IRRIGATION MANAGEMENT OFFICE" form="update_ld_form">
							<label class="form-check-label" for="update_nia_pimo">
							  NATIONAL IRRIGATION ADMINISTRATION - PANGASINAN IRRIGATION MANAGEMENT OFFICE
							</label>
						  </div>
						</div>
					  </div>
					  <div class="d-md-flex flex-row">
						<div class="flex-fill mb-3">
							<label for="ld_attachment">Attachment (Only PDF files are allowed)</label>
							<input type="file" class="form-control" id="update_ld_attachment" name ="ld_attachment" form="update_ld_form">

							<small class="text-muted" style="font-size: 12px;">This will overwirte your previous uploaded attachment (<span id="old_ld_attachement"></span>).</small>
						  </div>
					  </div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="submit" class="btn btn-primary" form="update_ld_form">Save changes</button>
				</div>
				</div>
				</div>
			</div>
		</div>
	</div>
  </div>

{% endblock %}

{%block scripts%}
<script type="text/javascript">

	document.getElementById('add_afl_form').addEventListener('submit', (e)=>{
		e.preventDefault();

		loadingScreen('block');

		var formElem = document.getElementById("add_afl_form");
		let formData = new FormData(formElem);

		const data = {}
		formData.forEach((value, key) => (data[key] = value))
		
		// console.log(data)
		fetch('/afl/add-afl/{{emp_id}}', {
				method: 'POST',
				body: formData
			}).then((res)=>{
				if (res.status == 413){
					// triggerToast("The selected file exceeds maximum limit size of 50MB."); 
				}else if (res.status == 406){
					 triggerToast("Invalid File Submitted.", 'error'); 
				}else{
					document.getElementById('add_ld_form').reset();
				}
				return res.json();

			}).then((data)=>{
					triggerToast(data, "success"); //this is the returned error message
					var table = $('#ld_table').DataTable();
					table.ajax.reload();
					nia_pimo();
					loadingScreen('none');
			})

	});

(function () {
  'use strict'

  // Fetch all the forms we want to apply custom Bootstrap validation styles to
  var forms = document.querySelectorAll('.needs-validation')

  // Loop over them and prevent submission
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }

        form.classList.add('was-validated')
      }, false)
    })

	

})()

document.getElementById('update_ld_form').addEventListener('submit', (e)=>{
	e.preventDefault();
	var id = document.getElementById('update_id').value;
	var url = `/ld/save-ld/${id}/{{user_profile.id}}`;
            loadingScreen('block');
            let formData4 = new FormData(document.getElementById("update_ld_form"));
                
                const data4 = {}
                formData4.forEach((value, key) => (data4[key] = value));
               
                fetch(url, {
                method: 'POST',
                body: formData4
                }).then((res)=>{
				if (res.status == 406){
					triggerToast('Invalid file submitted. Only PDF files are allowed.')
                }
                else if (res.status == 200){
					// triggerToast('Successfully Saved Changes.')
                    return res.json()
                }
                
                }).then((data)=>{
					// triggerToast(data)
					loadingScreen('none');
					var myModal = document.getElementById('viewExpModal');
					var modal = bootstrap.Modal.getInstance(myModal).hide()
					// modal.hide();
                  $('#ld_table').DataTable().ajax.reload()
                //   document.getElementById('work_experience_form').reset()
                //   window.location.reload()

                });//END
})

function edit_ld(el){

    fetch(`/ld/edit-ld/${el.id}`,{
		method: 'GET'
	})
		.then(response => response.json())
		.then(data => {
			console.log(data)
			document.getElementById('update_id').value = data[0].id;
			document.getElementById('update_ld_program').value = data[0].ld_program;
			document.getElementById('update_ld_date_from').value = data[0].ld_date_from;
			document.getElementById('update_ld_date_to').value = data[0].ld_date_to;
			document.getElementById('update_ld_no_hours').value = data[0].ld_no_hours;
			document.getElementById('update_ld_type').value = data[0].leave_id;
			document.getElementById('update_ld_sponsored_by').value = data[0].ld_sponsored_by;
			var file_dir = data[0].ld_attachment;
			document.getElementById('old_ld_attachement').innerHTML = "<a href='"+ file_dir +"' >"+data[0].ld_attachment_file_name+"</a>";
		});
  }



function delete_ld(el){
	// alert(el.id)
	loadingScreen("block");
	fetch('/ld/delete-ld',{
		method: 'POST',
		body: JSON.stringify({"ld_id" : el.id})
	})
		.then(response => response.json())
		.then(data => {
			// triggerToast(data)
			window.location.reload()
		});
}

function nia_pimo(){
		var nia_pimo = document.getElementById('nia_pimo');
		var station_place = document.getElementById('ld_sponsored_by');

		if(nia_pimo.checked){
			station_place.value = "";
			station_place.disabled = true;
			}
		else{
			station_place.disabled = false;
			}
	
	}

  function update_nia_pimo(){
		var nia_pimo = document.getElementById('update_nia_pimo');
		var station_place = document.getElementById('update_ld_sponsored_by');

		if(nia_pimo.checked){
			station_place.value = "NATIONAL IRRIGATION ADMINISTRATION - PANGASINAN IRRIGATION MANAGEMENT OFFICE";
			station_place.disabled = true;
			}
		else{
			station_place.disabled = false;
			}
	
	}

document.getElementById('nia_pimo').addEventListener('change', nia_pimo)
document.getElementById('update_nia_pimo').addEventListener('change', update_nia_pimo)

</script>
{%endblock%}